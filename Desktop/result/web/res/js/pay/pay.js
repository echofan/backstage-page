define("pay/pay",["libs/template"],function(t,n,a){var e=t("libs/template");e.helper("fenToyuan",function(t){var n=Math.ceil(t/100);return n}),e.helper("dateFormate",function(t){return t.substring(0,10)}),e.helper("arrayToString",function(t){return t.join(",")});var o={iscroll:null,curType:1,type1:{data:null},type2:{data:null}},r=0,i={productclass:null,curNum:0,discount:0,data:{}},u={},c={bindEvent:function(){$("body").delegate(".js-tap",$.Func.TAP,function(t){var n=$(this).data("handler");c[n]&&c[n].call(this)}),window.onhashchange=function(){var t=location.hash.replace("#","");"coupon"==t?$("body").addClass("showCounpons"):$("body").removeClass("showCounpons")}},modifyTitle:function(t){if(t){var n=$("body");document.title=t;var a=$('<iframe src="/favicon.ico"></iframe>').on("load",function(){setTimeout(function(){a.off("load").remove()},0)}).appendTo(n)}},productInfo:function(t){var n=this,a={jsonrpc:"2.0",method:"Product.PriceDetail",id:54321,params:{productclass:t}};$.Func.ajax(a,function(a){var o=a.result;if(o){i={productclass:t,curNum:0,discount:0,data:o.goods};var u=i.data[i.curNum].productname+"信息服务";r=o.goods[i.curNum].actualprice,n.modifyTitle(u),$("#title").html(u),$("#totalPrice").html(r.toFixed(2));var c=e("price-template",i.data[i.curNum]);$("#price").html(c),c=e("payment-template",o),$("#paymentList").html(c),n.checkCounpon()}})},reducePeriod:function(){var t=parseInt($("#period").val())||1,n=i.discount;t>1&&(t--,$("#period").val(t),r=i.data[i.curNum].actualprice*t,$("#totalPrice").html((r-n).toFixed(2)))},addPeriod:function(){var t=parseInt($("#period").val())||1,n=i.discount;t++,$("#period").val(t),r=i.data[i.curNum].actualprice*t,$("#totalPrice").html((r-n).toFixed(2))},showPrice:function(){var t=$(this).data("productid"),n=$(this).data("number"),a=parseInt($("#period").val())||1;i.curNum=n,i.discount=0,c.checkCounpon(),$("#paymentList .js-tap").removeClass("on").eq(n).addClass("on"),$("#productid").val(t),r=i.data[n].actualprice*a,$("#totalPrice").html(r.toFixed(2));var o=e("price-template",i.data[n]);$("#price").html(o)},showCoupons:function(){var t=c;$.Func.getUserInfo(),$.User.wxgzh&&(location.hash="coupon",t.couponUserObtain(o.curType,function(n){o.type1.data=n.data,t.renderCoupon(n)}))},getCounpons:function(t){var n=this;$.Func.getUserInfo(),$.User.wxgzh&&(o.type1.data?$.isFunction(t)&&t(o.type1.data):n.couponUserObtain(o.curType,function(n){o.type1.data=n.data,$.isFunction(t)&&t(n.data)}))},checkCounpon:function(){var t=this,n=0,a=$("#productid").val();t.getCounpons(function(t){t&&$.each(t,function(e,o){~$.inArray(a,o.productsavailable)&&n++,e==t.length-1&&($("#coupon").val(n),$("#couponLink").html(n+"张可用"))})})},useCoupon:function(){var t=$(this).data("couponid"),n=$(this).data("productid").toString().split("."),a=i.data[i.curNum].productid.toString(),e=$(this).data("amount");~$.inArray(a,n)?(i.discount=+e,$("#coupon").val(t),$("#couponLink").html("优惠"+e+"元"),location.hash="coupon"):$.Func.pop("这张优惠券不能用在当前产品上！")},createOrder:function(t,n,a,e){var o={jsonrpc:"2.0",method:"Product.CreateOrderGZH",id:54321,params:{userid:$.User.userid,openid:$.User.openid,productid:t,quantity:n,channelid:1,appenv:"weixin_gzh_nxb",couponid:a}};$.Func.ajax(o,function(t){var n=t.result;n&&e&&e(n)})},payWX:function(){var t=parseInt($("#productid").val()),n=parseInt($("#period").val())||1,a=t.toString()+"-"+n.toString(),e=parseInt($("#couponid").val())||0;return t?($("#btnLine").addClass("btnline-loading"),void(u.hasOwnProperty(a)?c.onpay(u[a]):c.createOrder(t,n,e,function(t){1==t.status?(u[a]=t,c.onpay(t)):($.Func.pop(t.statusmsg),$("#btnLine").removeClass("btnline-loading"))}))):($.Func.pop("请选择产品支付"),!1)},onpay:function(t){var n=c;wx.ready(function(){function a(){WeixinJSBridge.invoke("getBrandWCPayRequest",{appId:t.appId,timeStamp:t.timeStamp,nonceStr:t.nonceStr,"package":t["package"],signType:t.signType,paySign:t.paySign},function(a){"get_brand_wcpay_request:ok"==a.err_msg&&n.payCoupons(t.orderid,function(){var t=r.toFixed(2);location.href="pay_result.html?status=1&productid="+i.productclass+"&money="+t}),$("#btnLine").removeClass("btnline-loading")})}"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",a,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",a),document.attachEvent("onWeixinJSBridgeReady",a)):a()})},payCoupons:function(t,n){var a={jsonrpc:"2.0",method:"Coupon.CouponOrderGift",id:54321,params:{orderid:t,channel:100}};$.Func.ajax(a,function(t){var a=t.result;a&&$.isFunction(n)&&n(a)})},showTab:function(){var t=c,n=$(this).data("type")||1;o.curType=n,$(this).parent().children().removeClass("on"),$(this).addClass("on"),o["type"+n].data?t.renderCoupon(o["type"+n]):t.couponUserObtain(o.curType,function(a){t.renderCoupon(a),o["type"+n].data=a.data})},couponUserObtain:function(t,n){uin=$.User.userid;var a={jsonrpc:"2.0",method:"Coupon.CouponUserObtain",id:54321,params:{userid:uin,type:t}};$.Func.ajax(a,function(t){var a=t.result;a&&$.isFunction(n)&&n(a)})},renderCoupon:function(t){o.iscroll||(o.iscroll=new IScroll("#wrapper")),t.data?$("#wrapper").removeClass("show-empty"):$("#wrapper").addClass("show-empty");var n=e("li-template",t);$("#couponList").html(n),o.iscroll.refresh()},closeLayer:function(){$(this).parent().parent().removeClass("show")},filter:function(t){for(var n=new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>/?~！@#￥……&*（）—|{}【】‘；：”“'。，、？]"),a="",e=0;e<t.length;e++)a+=t.substr(e,1).replace(n,"");return a},init:function(){$.Func.getJSAPI();var t=$.Func.getParam("productid");t&&(t=this.filter(t),this.productInfo(t),this.bindEvent())}};a.exports=c});